{% extends "accuiel/Base.html" %}
{% load widget_tweaks %}

{% block content %}
<div class="container mt-5">
    <!-- Section pour afficher les informations sur la maison (inchangée) -->
    {% if maison %}
        <div class="mb-4 row">
            <div class="col-md-3">
                <div class="text-center alert alert-primary">
                    <h5>Maison</h5>
                    <p class="mb-0"><strong>{{ maison.nom }}</strong></p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center alert alert-info">
                    <h5>Nombre Total de Pièces</h5>
                    <p class="mb-0"><strong>{{ nombre_total_pieces }}</strong></p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center alert alert-success">
                    <h5>Nombre de Pièces Enregistrées</h5>
                    <p class="mb-0"><strong>{{ pieces_enregistrees }}</strong></p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center alert alert-warning">
                    <h5>Nombre de Pièces Non Enregistrées</h5>
                    <p class="mb-0"><strong>{{ pieces_non_enregistrees }}</strong></p>
                </div>
            </div>
        </div>
    {% endif %}

    <div class="shadow-lg card">
        <div class="text-center text-white card-header bg-primary">
            <h2>Ajouter une Chambre</h2>
        </div>
        <div class="card-body">
            <!-- Afficher les erreurs générales du formulaire (inchangé) -->
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}

            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- ############# DÉBUT DE LA CORRECTION ############# -->
                
                {% for field in form %}
                    {% if field.name != 'maison' %}
                        
                        {# Traitement spécial pour le champ 'surface' #}
                        {% if field.name == 'surface' %}
                        <div class="mb-3">
                            <label for="{{ field.id_for_label }}" class="form-label"><strong>{{ field.label }}</strong></label>
                            <div class="input-group">
                                {# On rend le champ 'readonly' pour forcer l'utilisation de la modale #}
                                {{ field|add_class:"form-control"|attr:"readonly:readonly"|attr:"placeholder:Utiliser le calculateur..." }}
                                {# Le bouton qui déclenche l'ouverture de la modale #}
                                <button class="btn btn-outline-primary" type="button" onclick="ouvrirSurfaceOptions()">
                                    <i class="fas fa-calculator"></i> Calculer
                                </button>
                            </div>
                            {% if field.help_text %}
                                <small class="form-text text-muted">{{ field.help_text }}</small>
                            {% endif %}
                            {% if field.errors %}
                                <div class="text-danger">
                                    {% for error in field.errors %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        {# Traitement normal pour tous les autres champs #}
                        {% else %}
                        <div class="mb-3">
                            <label for="{{ field.id_for_label }}" class="form-label"><strong>{{ field.label }}</strong></label>
                            {{ field|add_class:"form-control" }}
                            {% if field.help_text %}
                                <small class="form-text text-muted">{{ field.help_text }}</small>
                            {% endif %}
                            {% if field.errors %}
                                <div class="text-danger">
                                    {% for error in field.errors %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {% endif %}

                    {% endif %}
                {% endfor %}

                <!-- ############## FIN DE LA CORRECTION ############## -->

                <div class="text-center">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                    <a href="{% url 'liste_chambres' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Annuler
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modale pour le calcul de la surface (inchangée) -->
<div class="modal fade" id="surfaceModal" tabindex="-1" aria-labelledby="surfaceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="text-white modal-header bg-primary">
        <h5 class="modal-title" id="surfaceModalLabel">Calcul de la surface</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <label class="form-label"><strong>Type de pièce</strong></label>
        <select id="type_selection" class="mb-3 form-select" onchange="afficherZoneDimensions()">
          <option value="" selected>-- Choisir un type --</option>
          <option value="chambre">Chambre simple</option>
          <option value="salon">Salon simple</option>
          <option value="chambre_salon">Chambre + Salon</option>
        </select>

        <div id="zone-chambre" style="display: none;" class="p-3 mb-2 border rounded">
          <h5><i class="fas fa-bed"></i> Dimensions Chambre</h5>
          <div class="input-group">
            <span class="input-group-text">L</span>
            <input type="number" id="longueur_chambre" class="form-control" placeholder="Longueur (m)" oninput="calculerSurfaceFormatee()">
            <span class="input-group-text">x l</span>
            <input type="number" id="largeur_chambre" class="form-control" placeholder="Largeur (m)" oninput="calculerSurfaceFormatee()">
          </div>
        </div>

        <div id="zone-salon" style="display: none;" class="p-3 border rounded">
          <h5><i class="fas fa-couch"></i> Dimensions Salon</h5>
          <div class="input-group">
            <span class="input-group-text">L</span>
            <input type="number" id="longueur_salon" class="form-control" placeholder="Longueur (m)" oninput="calculerSurfaceFormatee()">
            <span class="input-group-text">x l</span>
            <input type="number" id="largeur_salon" class="form-control" placeholder="Largeur (m)" oninput="calculerSurfaceFormatee()">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-success" onclick="validerSurface()">
            <i class="fas fa-check"></i> Valider et Reporter
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Script Javascript (inchangé, il est maintenant fonctionnel) -->
<script>
function ouvrirSurfaceOptions() {
    // Crée une nouvelle instance de la modale Bootstrap et l'affiche
    const modal = new bootstrap.Modal(document.getElementById('surfaceModal'));
    modal.show();
}

function afficherZoneDimensions() {
    const type = document.getElementById('type_selection').value;
    const zoneChambre = document.getElementById('zone-chambre');
    const zoneSalon = document.getElementById('zone-salon');

    // Réinitialise l'affichage
    zoneChambre.style.display = 'none';
    zoneSalon.style.display = 'none';

    if (type === 'chambre') {
        zoneChambre.style.display = 'block';
    } else if (type === 'salon') {
        zoneSalon.style.display = 'block';
    } else if (type === 'chambre_salon') {
        zoneChambre.style.display = 'block';
        zoneSalon.style.display = 'block';
    }
}

// Fonction optionnelle pour afficher le calcul en temps réel (pas nécessaire pour le fonctionnement)
function calculerSurfaceFormatee() {
    // Cette fonction reste vide pour l'instant mais pourrait être utilisée
    // pour afficher un aperçu du calcul dans la modale.
}

function validerSurface() {
    const type = document.getElementById('type_selection').value;

    const lc = parseFloat(document.getElementById('longueur_chambre').value) || 0;
    const Lc = parseFloat(document.getElementById('largeur_chambre').value) || 0;
    const ls = parseFloat(document.getElementById('longueur_salon').value) || 0;
    const Ls = parseFloat(document.getElementById('largeur_salon').value) || 0;

    let surfaceChambre = 0;
    let surfaceSalon = 0;

    if (type === 'chambre' || type === 'chambre_salon') {
        surfaceChambre = lc * Lc;
    }
    if (type === 'salon' || type === 'chambre_salon') {
        surfaceSalon = ls * Ls;
    }

    const surfaceTotale = surfaceChambre + surfaceSalon;

    let texteFinal = "";
    if (type === 'chambre_salon') {
        texteFinal = `Chambre ${surfaceChambre.toFixed(2)} m² + Salon ${surfaceSalon.toFixed(2)} m² (Total: ${surfaceTotale.toFixed(2)} m²)`;
    } else if (type === 'chambre') {
        texteFinal = `Chambre ${surfaceChambre.toFixed(2)} m²`;
    } else if (type === 'salon') {
        texteFinal = `Salon ${surfaceSalon.toFixed(2)} m²`;
    }

    // Si aucun calcul n'a été fait, on ne remplit pas le champ
    if (surfaceTotale > 0) {
        document.getElementById('id_surface').value = texteFinal;
    }

    // On récupère l'instance de la modale et on la ferme
    const modalElement = document.getElementById('surfaceModal');
    const modalInstance = bootstrap.Modal.getInstance(modalElement);
    modalInstance.hide();
}
</script>

{% endblock %}