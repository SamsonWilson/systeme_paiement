{% extends "accuiel/base.html" %}
{% load humanize %} {# Optionnel: pour améliorer l'affichage des nombres/prix si 'humanize' est dans INSTALLED_APPS #}

{% block content %}
<style>
    body { 
        font-family: sans-serif; 
    }
    .table-container {
        margin: 20px;
        overflow-x: auto; /* Permet le défilement horizontal si la table est trop large */
    }
    table.chambres-table {
        width: 100%;
        border-collapse: collapse; /* Fusionne les bordures des cellules */
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Ajoute une légère ombre */
    }
    table.chambres-table th, 
    table.chambres-table td {
        border: 1px solid #ddd; /* Bordure grise légère */
        padding: 10px 12px; /* Espacement intérieur des cellules */
        text-align: left; /* Alignement du texte */
        vertical-align: top; /* Alignement vertical en haut */
    }
    table.chambres-table thead th {
      background-color: #f2f2f2; /* Fond gris clair pour l'en-tête */
      font-weight: bold; /* Texte en gras */
      position: sticky; /* En-tête fixe lors du défilement vertical (facultatif) */
      top: 0; /* Nécessaire pour sticky */
      z-index: 1; /* Pour s'assurer qu'il reste au-dessus */
    }
    table.chambres-table tbody tr:nth-child(even) {
        background-color: #f9f9f9; /* Alternance de couleur pour les lignes */
    }
    table.chambres-table tbody tr:hover {
        background-color: #f1f1f1; /* Changement de couleur au survol */
    }
    .etat-occupee {
        font-weight: bold;
        color: #c0392b; /* Couleur rouge pour 'Occupée' */
    }
    .no-data {
        text-align: center;
        padding: 20px;
        color: #777;
    }
</style>

<div class="table-container">
    <h1>Liste des Chambres Occupées</h1>

    {% if locations_occupees %}
        <table class="chambres-table">
            <thead>
                <tr>
                    <th>Ch.ID</th>
                    <th>Type Chambre</th>
                    <th>Locataire</th>
                    <th>Utilisateur</th> {# Ajouté: Username du locataire #}
                    <th>Surface</th>
                    <th>Prix / mois</th>
                    <th>Maison</th>
                    <th>Propriétaire</th>
                    <th>État</th>
                </tr>
            </thead>
            <tbody>
                {% for location in locations_occupees %}
                    {# Assurez-vous que la chambre associée existe #}
                    {% with chambre=location.chambre %} 
                        {% if chambre %} {# Vérification importante #}
                        <tr>
                            <td>{{ chambre.id }}</td>
                            <td>{{ chambre.type_chambre.nom|default:"N/A" }}</td>
                            
                            {# Affichage sécurisé du locataire #}
                            <td>
                                {% if location.utilisateur %}
                                    {{ location.utilisateur.prenom }} {{ location.utilisateur.nom }}
                                {% else %}
                                    <span style="color: red;">Utilisateur non défini</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if location.utilisateur %}
                                    {{ location.utilisateur.username }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>

                            <td>{{ chambre.surface|default:"N/A" }} m²</td>
                            
                            {# Affichage formaté du prix (exemple avec humanize) #}
                            <td>
                                {% if chambre.prix is not None %}
                                    {{ chambre.prix|floatformat:"0"|intcomma }} FCFA 
                                    {# intcomma ajoute des séparateurs de milliers, floatformat:0 enlève les décimales #}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>

                            {# Affichage sécurisé de la maison #}
                            <td>
                                {% if chambre.maison %}
                                    {{ chambre.maison.nom }} <br>
                                    <small>{{ chambre.maison.adresse }}</small>
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>

                            {# Affichage sécurisé du propriétaire #}
                            <td>
                                {% if chambre.maison and chambre.maison.proprietaire %}
                                    {{ chambre.maison.proprietaire.prenom }} {{ chambre.maison.proprietaire.nom }}
                                {% elif chambre.maison %}
                                    Propriétaire non défini
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            
                            {# Affichage de l'état #}
                            <td class="etat-occupee">{{ chambre.get_etat_display|upper }}</td>
                        </tr>
                        {% else %}
                        {# Cas où la location n'a pas de chambre associée (ne devrait pas arriver si les données sont cohérentes) #}
                        <tr>
                            <td colspan="9" style="color: red; text-align: center;">
                                Erreur : Location ID {{ location.id }} sans chambre associée.
                            </td>
                        </tr>
                        {% endif %}
                    {% endwith %}
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="no-data">Aucune chambre n'est actuellement enregistrée comme occupée.</p>
    {% endif %}
</div>

{% endblock %}