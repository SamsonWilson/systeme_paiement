{% extends "accuiel/base.html" %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4 text-center">Créer une Location</h2>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-3">
            {{ form.utilisateur.label_tag }}
            {{ form.utilisateur }}
        </div>
        <div class="mb-3">
            {{ form.chambre.label_tag }}
            {{ form.chambre }}
        </div>
        <div class="mb-3">
            {{ form.date_debut_location.label_tag }}
            {{ form.date_debut_location }}
        </div>
        <div class="mb-3">
            {{ form.nombre_mois_paye.label_tag }}
            {{ form.nombre_mois_paye }}
        </div>
        <div class="mb-3">
            {{ form.date_fin_avance.label_tag }}
            {{ form.date_fin_avance }}
        </div>
        <div class="mb-3">
            {{ form.montant_avance.label_tag }}
            {{ form.montant_avance }}
        </div>
        <div class="mb-3">
            {{ form.montant_caution.label_tag }}
            {{ form.montant_caution }}
        </div>
        <div class="mb-3">
            {{ form.commission.label_tag }}
            {{ form.commission }}
        </div>
        <div class="mb-3">
            {{ form.montant_total.label_tag }}
            {{ form.montant_total }}
        </div>
        <div class="mb-3">
            {{ form.image_contrat.label_tag }}
            {{ form.image_contrat }}
        </div>
        <div class="mb-3">
            {{ form.statut_paiement.label_tag }}
            {{ form.statut_paiement }}
        </div>
        <div class="mb-3">
            {{ form.mode_paiement.label_tag }}
            {{ form.mode_paiement }}
        </div>
        <div class="mb-3">
            {{ form.date_paiement.label_tag }}
            {{ form.date_paiement }}
        </div>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
    </form>
</div>

<script>
    // Récupérer les champs du formulaire
    const chambreInput = document.getElementById("id_chambre");
    const nombreMoisInput = document.getElementById("id_nombre_mois_paye");
    const montantTotalInput = document.getElementById("id_montant_total");
    const dateDebutInput = document.getElementById("id_date_debut_location");
    const dateFinInput = document.getElementById("id_date_fin_avance");

    // Fonction pour récupérer le prix de la chambre sélectionnée
    async function getPrixChambre(chambreId) {
        // Remplacez cette URL par l'URL de votre API ou vue Django qui retourne le prix de la chambre
        const response = await fetch(`/api/chambres/${chambreId}/prix/`);
        if (response.ok) {
            const data = await response.json();
            return data.prix; // Retourne le prix de la chambre
        }
        return 0; // Retourne 0 si une erreur survient
    }

    // Fonction pour calculer le montant total
    async function calculerMontantTotal() {
        const chambreId = chambreInput.value;
        const nombreMois = parseInt(nombreMoisInput.value);

        if (chambreId && !isNaN(nombreMois) && nombreMois > 0) {
            const prixChambre = await getPrixChambre(chambreId);
            const montantTotal = prixChambre * nombreMois;
            montantTotalInput.value = montantTotal.toFixed(2); // Mettre à jour le champ "montant_total"
        } else {
            montantTotalInput.value = ""; // Réinitialiser si les valeurs sont invalides
        }
    }

    // Fonction pour calculer la date de fin
    function calculerDateFin() {
        const dateDebut = new Date(dateDebutInput.value);
        const nombreMois = parseInt(nombreMoisInput.value);

        if (!isNaN(dateDebut.getTime()) && !isNaN(nombreMois)) {
            // Ajouter le nombre de mois à la date de début
            dateDebut.setMonth(dateDebut.getMonth() + nombreMois);
            // Mettre à jour le champ "date_fin_avance"
            dateFinInput.value = dateDebut.toISOString().split("T")[0];
        }
    }

    // Ajouter des écouteurs d'événements pour recalculer les champs
    chambreInput.addEventListener("change", calculerMontantTotal);
    nombreMoisInput.addEventListener("input", () => {
        calculerMontantTotal();
        calculerDateFin();
    });
    dateDebutInput.addEventListener("change", calculerDateFin);
</script>
{% endblock %}