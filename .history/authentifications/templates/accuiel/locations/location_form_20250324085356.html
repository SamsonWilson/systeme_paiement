{% extends "accuiel/base.html" %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4 text-center">Créer une Location</h2>

    <!-- Afficher les informations de l'utilisateur -->
    <div class="alert alert-info">
        <p><strong>Utilisateur :</strong> {{ utilisateur.nom }} {{ utilisateur.prenom }}</p>
        <p><strong>Email :</strong> {{ utilisateur.email }}</p>
    </div>

    <!-- Afficher les informations de la chambre -->
    <div class="alert alert-info">
        <p><strong>Type de chambre :</strong> {{ chambre.type_chambre.nom }}</p>
        <p><strong>Prix :</strong> {{ chambre.prix }} CFA</p>
        <p><strong>Surface :</strong> {{ chambre.surface }} m²</p>
        <p><strong>Taux de commission :</strong> {{ chambre.taux_commission }}%</p>
    </div>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-3">
            {{ form.date_debut_location.label_tag }}
            {{ form.date_debut_location }}
        </div>
        <div class="mb-3">
            {{ form.nombre_mois_paye.label_tag }}
            {{ form.nombre_mois_paye }}
        </div>
        <div class="mb-3">
            {{ form.montant_caution.label_tag }}
            {{ form.montant_caution }}
        </div>
        <div class="mb-3">
            {{ form.image_contrat.label_tag }}
            {{ form.image_contrat }}
        </div>
        <div class="mb-3">
            {{ form.statut_paiement.label_tag }}
            {{ form.statut_paiement }}
        </div>
        <div class="mb-3">
            {{ form.mode_paiement.label_tag }}
            {{ form.mode_paiement }}
        </div>
        <div class="mb-3">
            {{ form.date_paiement.label_tag }}
            {{ form.date_paiement }}
        </div>
        <div class="mb-3">
            {{ form.date_fin_avance.label_tag }}
            {{ form.date_fin_avance }}
        </div>
        <div class="mb-3">
            {{ form.montant_avance.label_tag }}
            {{ form.montant_avance }}
        </div>
        <div class="mb-3">
            {{ form.commission.label_tag }}
            {{ form.commission }}
        </div>
        <div class="mb-3">
            {{ form.montant_total.label_tag }}
            {{ form.montant_total }}
        </div>
        <div class="mb-3">
            {{ form.image_contrat.label_tag }}
            {{ form.image_contrat }}
        </div>
        <div class="mb-3">
            {{ form.statut_paiement.label_tag }}
            {{ form.statut_paiement }}
        </div>
        <div class="mb-3">
            {{ form.mode_paiement.label_tag }}
            {{ form.mode_paiement }}
        </div>
        <div class="mb-3">
            {{ form.date_paiement.label_tag }}
            {{ form.date_paiement }}
        </div>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
    </form>
</div>

<script>
    // Récupérer les champs du formulaire
    const dateDebutInput = document.getElementById("id_date_debut_location");
    const nombreMoisInput = document.getElementById("id_nombre_mois_paye");
    const dateFinInput = document.getElementById("id_date_fin_avance");
    const montantAvanceInput = document.getElementById("id_montant_avance");
    const montantCautionInput = document.getElementById("id_montant_caution");
    const montantTotalInput = document.getElementById("id_montant_total");
    const commissionInput = document.getElementById("id_commission");

    // Vérifier si les champs existent
    if (!dateDebutInput || !nombreMoisInput || !dateFinInput || !montantAvanceInput || !montantCautionInput || !montantTotalInput || !commissionInput) {
        console.error("Un ou plusieurs champs du formulaire sont introuvables.");
    }

    // Variables pour les informations de la chambre
    const prixChambre = parseFloat({{ chambre.prix }});
    const tauxCommission = parseFloat({{ chambre.taux_commission }});

    // Fonction pour calculer la date de fin
    function calculerDateFin() {
        const dateDebut = new Date(dateDebutInput.value);
        const nombreMois = parseInt(nombreMoisInput.value);

        if (!isNaN(dateDebut.getTime()) && !isNaN(nombreMois)) {
            // Ajouter le nombre de mois à la date de début
            dateDebut.setMonth(dateDebut.getMonth() + nombreMois);
            // Mettre à jour le champ "date_fin_avance"
            dateFinInput.value = dateDebut.toISOString().split("T")[0];
        } else {
            dateFinInput.value = ""; // Réinitialiser si les valeurs sont invalides
        }
    }

    // Fonction pour calculer le montant total, le montant d'avance et la commission
    function calculerMontants() {
        const nombreMois = parseInt(nombreMoisInput.value);
        const montantCaution = parseFloat(montantCautionInput.value) || 0;

        if (!isNaN(nombreMois) && nombreMois > 0) {
            // Calculer le montant d'avance
            const montantAvance = prixChambre * nombreMois;
            montantAvanceInput.value = montantAvance.toFixed(2);

            // Calculer la commission
            const commission = (montantAvance * tauxCommission) / 100;
            commissionInput.value = commission.toFixed(2);

            // Calculer le montant total (avance + caution)
            const montantTotal = montantAvance + montantCaution;
            montantTotalInput.value = montantTotal.toFixed(2);
        } else {
            montantAvanceInput.value = ""; // Réinitialiser si les valeurs sont invalides
            commissionInput.value = "";
            montantTotalInput.value = "";
        }
    }

    // Ajouter des écouteurs d'événements pour recalculer les champs
    if (dateDebutInput && nombreMoisInput) {
        dateDebutInput.addEventListener("change", calculerDateFin);
        nombreMoisInput.addEventListener("input", () => {
            calculerDateFin();
            calculerMontants();
        });
        montantCautionInput.addEventListener("input", calculerMontants);
    }
</script>
{% endblock %}