{% extends 'accuiel/base.html' %}

{% block content %}
<div class="chat-container">
    <div class="sidebars">
        <h3>Conversations</h3>
        {% if all_users %}
            <div class="user-list">
                {% for user in all_users %}
                    <div>
                        <a href="{% url 'chat_page' receiver_id=user.id %}">
                            {{ user.username }}
                        </a>
                    </div>
                {% empty %}
                    <p>Aucun utilisateur disponible.</p>
                {% endfor %}
            </div>
        {% else %}
            <p>Aucun utilisateur trouvé.</p>
        {% endif %}
    </div>

    <div class="chat-box">
        <div class="chat-header">
            {% if chat_user %}
                <h4>Conversation avec {{ chat_user.username }}</h4>
            {% else %}
                <h4>Sélectionnez un utilisateur pour commencer une conversation</h4>
            {% endif %}
        </div>

        <div class="messages" id="chat-box">
            {% for msg in messages %}
                <div class="{% if msg.sender == user %}sent{% else %}received{% endif %}">
                    <p>{{ msg.message }}</p>
                    <span class="timestamp">{{ msg.timestamp|date:"H:i" }}</span>
                </div>
            {% endfor %}
        </div>

        <form id="message-form" class="message-form" method="post">
            {% csrf_token %}
            <input type="text" name="message" placeholder="Écrivez un message..." required>
            <button type="submit">Envoyer</button>
        </form>
    </div>
</div>

<script>
    let receiverId = "{{ chat_user.id }}";  // ID du destinataire
    const messageForm = document.getElementById('message-form');
    const messageInput = messageForm.querySelector('input[name="message"]');
    const chatBox = document.getElementById('chat-box');

    // Envoi du message
    messageForm.addEventListener('submit', function(event) {
        event.preventDefault();

        const message = messageInput.value.trim();
        if (message !== '') {
            fetch(`/messagerie/messages/${receiverId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `message=${message}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Message envoyé avec succès") {
                    const newMessage = document.createElement('div');
                    newMessage.className = 'sent';
                    newMessage.innerHTML = `<p>${message}</p><span class="timestamp">Maintenant</span>`;
                    chatBox.appendChild(newMessage);
                    messageInput.value = '';  // Effacer le champ
                } else {
                    console.error('Erreur:', data.message);
                }
            })
            .catch(err => console.error('Erreur:', err));
        }
    });
</script>
{% endblock %}
