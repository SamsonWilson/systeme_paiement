{% extends 'base.html' %} {# Assurez-vous d'hÃ©riter de votre template de base #}

{% block content %}
<style>
    .chat-container {
        max-width: 800px;
        margin: 2rem auto;
        display: flex;
        flex-direction: column;
        height: 80vh; /* Hauteur de 80% de la vue */
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.07);
        overflow: hidden;
    }

    /* En-tÃªte du chat */
    .chat-header {
        padding: 1rem 1.5rem;
        background-color: #f7f9fc;
        border-bottom: 1px solid #e9ecef;
        flex-shrink: 0;
    }
    .chat-header h2 {
        margin: 0;
        font-size: 1.25rem;
        color: #212529;
    }
    .chat-header a {
        color: #007bff;
        text-decoration: none;
        font-size: 0.9rem;
    }
    .chat-header a:hover { text-decoration: underline; }

    /* Zone des messages (scrollable) */
    .messages-area {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background-color: #f1f3f5;
    }

    /* Bulles de message */
    .message-bubble {
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 18px;
        margin-bottom: 1rem;
        line-height: 1.5;
    }
    .message-bubble .sender {
        font-size: 0.8rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }
    .message-bubble .timestamp {
        font-size: 0.75rem;
        color: #6c757d;
        text-align: right;
        margin-top: 0.5rem;
    }

    /* Messages reÃ§us (Ã  gauche) */
    .message-received {
        background-color: #ffffff;
        border: 1px solid #e9ecef;
        border-top-left-radius: 4px;
        margin-right: auto;
    }

    /* Messages envoyÃ©s (Ã  droite) */
    .message-sent {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        border-top-right-radius: 4px;
        margin-left: auto;
    }
    .message-sent .timestamp { color: #31708f; }

    /* Images dans les messages */
    .message-image {
        max-width: 100%;
        border-radius: 10px;
        margin-top: 0.5rem;
        cursor: pointer;
    }

    /* Formulaire d'envoi */
    .message-form-container {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e9ecef;
        background-color: #f7f9fc;
        flex-shrink: 0;
    }
    .message-form-container form {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .message-form-container textarea {
        flex-grow: 1;
        border: 1px solid #ced4da;
        border-radius: 18px;
        padding: 0.5rem 1rem;
        resize: none;
        font-size: 1rem;
    }
    .message-form-container input[type="file"] {
        display: none; /* Cache l'input de fichier par dÃ©faut */
    }
    .file-upload-btn, .send-btn {
        border: none;
        background-color: transparent;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
        color: #6c757d;
    }
    .file-upload-btn:hover, .send-btn:hover { color: #007bff; }
</style>

<div class="chat-container">
    <header class="chat-header">
        <a href="{% url 'message_inbox' %}">&larr; Retour</a>
        <h2>Conversation pour : {{ maison.nom }}</h2>
    </header>

    <main class="messages-area" id="message-area-scroller">
        {% for message in messages %}
            <div class="message-bubble {% if message.sender == user %}message-sent{% else %}message-received{% endif %}">
                <div class="sender">{{ message.sender.get_full_name|default:message.sender.username }}</div>
                
                {% if message.message %}
                    <p class="mb-0">{{ message.message|linebreaksbr }}</p>
                {% endif %}

                {% if message.image %}
                    <a href="{{ message.image.url }}" target="_blank">
                        <img src="{{ message.image.url }}" alt="Image de {{ message.sender }}" class="message-image">
                    </a>
                {% endif %}

                <div class="timestamp">{{ message.timestamp|date:"d M, H:i" }}</div>
            </div>
        {% endfor %}
    </main>

    <footer class="message-form-container">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- Lien stylisÃ© pour dÃ©clencher l'upload de fichier -->
            <label for="{{ form.image.id_for_label }}" class="file-upload-btn" title="Joindre une image">ðŸ“Ž</label>
            {{ form.image }} <!-- L'input rÃ©el est cachÃ© -->

            <!-- Champ de texte pour le message -->
            {{ form.message }}

            <button type="submit" class="send-btn" title="Envoyer">âž¤</button>
        </form>
    </footer>
</div>

<script>
    // Petit script pour scroller automatiquement en bas de la conversation
    document.addEventListener('DOMContentLoaded', function() {
        const messageArea = document.getElementById('message-area-scroller');
        messageArea.scrollTop = messageArea.scrollHeight;
    });
</script>
{% endblock %}